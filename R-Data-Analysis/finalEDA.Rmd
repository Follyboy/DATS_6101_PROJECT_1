---
title: "finalEDA"
author: "Team 6"
date: "2022-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Importing all the relevant packages and libraries 

```{r results='markup'}
#install packages
#remotes::install_github("cran/DMwR")
#install.packages("moments")
#install.packages("DataExplorer")

#import libraries all
library(ggplot2)
library(moments)
library(dplyr)
library(DMwR)
library(SmartEDA) 
library(DataExplorer)
library("corrplot")
``` 

Importing our dataset and checking summary
```{r results='markup'}
#importing brain dataset
data <- data.frame(read.csv("dataset.csv"))


#checking the structure of our dataset 
str(data)

#since ID won't be useful during prediction so removing that 
brainData <- select(data, -c('id'))

#checking top5 entries in our dataset 
head(brainData)
```

Checking the summary of our dataset
```{r results='markup'}
summary(brainData)
```

Since most of the varibales our categorical, converting them to factors
```{r results='markup'}
#Converting gender,hypertension,heart_disease,ever_married,work_type,Residence_type,smoking_status,stroke to factors
brainData$gender = factor(brainData$gender)
brainData$hypertension = factor(brainData$hypertension)
brainData$heart_disease = factor(brainData$heart_disease)
brainData$ever_married = factor(brainData$ever_married)
brainData$work_type = factor(brainData$work_type)
brainData$Residence_type = factor(brainData$Residence_type)
brainData$smoking_status = factor(brainData$smoking_status)
brainData$stroke = factor(brainData$stroke)
str(brainData)
summary(brainData)
```


*We can see missing values in bmi, smoking_status \
**Class Imbalance problem** \
we have 42617 observations for stroke = 0 and 783 observations for stroke =1 \
\ 

Checking Box Plots for visualizing numeric variables
```{r results='markup'}
#concise box plot for numeric variables
plot_boxplot(brainData, by = "stroke")

```

Cleaning the dataset

Removing missing Values for smoking status 
```{r results='markup'}
cleanData = brainData
cleanData[cleanData == ''] <- NA
nrow(cleanData)
cleanData <- subset(cleanData, !is.na(smoking_status))
nrow(cleanData)
```
```{r, results='markup'}
table(cleanData$gender)
```
Since other gender entries are very less, we will just drop the other rows.

```{r, results='markup'}
drop_others = subset(cleanData, cleanData$gender != 'Other')
table(drop_others$gender)
cleanData <- drop_others

```


Analysis for BMI NULL values.
```{r, results='markup'}
ggplot(data=brainData, aes(bmi)) +
geom_histogram(col="black",
fill="blue") +
labs(x="bmi", y="frequency") +
labs(title="plot of bmi")
```
```{r, results='markup'}
tempdf <- subset(brainData, !is.na(bmi))  # removing NA values from bmi and storing it in tempdf
density_bmi <- density(tempdf$bmi)
plot(density_bmi)    #plotting the density curve of bmi values

ggplot(data = tempdf, mapping = aes(y = bmi)) +
  geom_boxplot() + geom_boxplot( colour="black", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=2)  #plotting the boxplot for bmi values.
```
```{r, results='markup'}
skewness_value <- skewness(tempdf$bmi)
```
Skewness value: `r skewness_value`


From the density curve and skewness value, BMI is rightly skewed. So mean is not the right central tendency to fill NA values in BMI.
We will NA values in BMI using median of the data.
Note: Negative skewness value indicates left skewed and positive skewness value indicates right skewed.
The rule of thumb seems to be:

If the skewness is between -0.5 and 0.5, the data are fairly symmetrical
If the skewness is between -1 and â€“ 0.5 or between 0.5 and 1, the data are moderately skewed
If the skewness is less than -1 or greater than 1, the data are highly skewed

Replacing Missing Values for BMI with median.
```{r results='markup'}

#removing missing values for BMI
cleanData$bmi[is.na(cleanData$bmi)] <- median(cleanData$bmi, na.rm = T) #replacing NA values with median of the remaining bmi values.
summary(cleanData)
```

Removing Outliers for BMI 
```{r results='markup'}

dim(cleanData)
quartiles_bmi <- quantile(cleanData$bmi, probs=c(.25, .75), na.rm = FALSE)
IQR_bmi <- IQR(cleanData$bmi)

 
Lower_bmi <- quartiles_bmi[1] - 1.5*IQR_bmi
Upper_bmi <- quartiles_bmi[2] + 1.5*IQR_bmi

#since all the missing values are for stroke =0 entries, we will directly drop it

cleanData <- subset(cleanData, cleanData$bmi > Lower_bmi & cleanData$bmi < Upper_bmi)

dim(cleanData)
```
We won't be removing Outliers for Age and Average level because\
1) max value of age is 82, so nothing is unusual about that \
2)avg_glucose_level is losing the relationship with stroke if we remove the outliers \
When we try to upsample that difference is even more nullified \



Let's check the distribution for numeric variables, bmi,age, avg_glucose_level : boxplot(outlier) and histogram(normal) => outliers **while doing avg_glucose_level and bmi => groupwise analysis as well**

Making a separate column for average glucose level \
Here as we can see, people who have diabetes are more likely to get stroke.

```{r results='markup'}
cleanData$glucoseGroup=cut(cleanData$avg_glucose_level, c(0, 114, 140, Inf), c("Normal", "Prediabetes", "Diabetes"), include.lowest=TRUE)
#0-114 : Normal glucose level
#114-140 : Prediabetes
#140- infinity : Diabetes 

#glucoseGroup to stroke relations
#ggbarstats(data=cleanData,y=glucoseGroup,x=stroke,label="both")
#people with diabetes have a high chance of getting stroke 
df_glucose <- cleanData %>%
  group_by(glucoseGroup, stroke) %>%
  count(stroke)
#grouping data into three glucose level

df_glucose %>%
ggplot(mapping = aes(x = glucoseGroup, y = n, fill = factor(stroke))) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Percentage of subjects with Different Glucose Level", 
       x = "glucoseGroup", 
       y = "Percentage") +
  scale_fill_brewer(palette = "Paired")

```

```{r results='markup'}

table(cleanData$stroke)
#use SMOTE to create new dataset that is more balanced
cleanData <- SMOTE(stroke ~ ., cleanData, perc.over = 2000, perc.under = 200)
#minority => 2000/100 =20 so 20*(strok1Observations=416) #upsampling 
#200/100 =2, make the majority observation 2 time the minority observations #downsampling 

#view distribution of response variable in new dataset
table(cleanData$stroke)
```


```{r, results='markup'}

ggplot(data = cleanData, mapping = aes(x = stroke, y = bmi, fill=stroke)) +
  geom_boxplot()
```
With the boxplot above, subjects who have stroke has slightly lower BMI than subjects who did not have stroke. 

```{r, results='markup'}
ggplot(data = cleanData, mapping = aes(x = stroke, y = bmi, fill = stroke, color = gender)) +
  geom_boxplot() +
  labs(title = "Boxplot of BMI", 
       x = "Stroke", 
       y = "BMI") +
  scale_fill_brewer(palette = "Paired")
```
From the box plots above, there is no strong evidence of subjects having stroke with respect to BMI and gender.


**Average Glucose Level**
As seen from below graph, even though before upsampling data the higher value of glucose level were contributing to the chances of stroke i.e stroke = 1.

Average Glucose Level after upsampling

```{r results='markup'}
df_glucose <- cleanData %>%
  group_by(glucoseGroup, stroke) %>%
  count(stroke)
#grouping data into three glucose level

df_glucose %>%
ggplot(mapping = aes(x = glucoseGroup, y = n, fill = factor(stroke))) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Percentage of subjects with Different Glucose Level", 
       x = "glucoseGroup", 
       y = "Percentage") +
  scale_fill_brewer(palette = "Paired")
```


After Upsampling the relationship is lost. 
```{r results='markup'}
get_box_stats <- function(y, upper_limit = max(brainData$avg_glucose_level) * 1.15) {
  return(data.frame(
    y = 0.95 * upper_limit,
    label = paste(
      "Count =", length(y), "\n",
      "Mean =", round(mean(y), 2), "\n",
      "Median =", round(median(y), 2), "\n"
    )
  ))
}

ggplot(cleanData, aes(x = stroke, y = avg_glucose_level, fill = stroke)) +
  geom_boxplot() +
  labs(title = "avg glucose level distribution before sampling")+
  scale_fill_manual(values = c("#0099f8", "#e74c3c", "#2ecc71")) +
  stat_summary(fun.data = get_box_stats, geom = "text", hjust = 0.5, vjust = 0.9) +
  theme_classic()

```


```{r results='markup'}

# percent of people with and without stroke for glucose level in three categories 
ExpCatViz(
  cleanData %>% 
    select(stroke, glucoseGroup), 
  target="stroke",col=c("Blue", "red"))
```

As seen above, average glucose level or diabetic level of sugar is impacting the percentage of people with strokes and not.
The difference is huge for Diabetic Category


```{r, results='markup'}
ggplot(cleanData, aes(x = age)) +
geom_density() +
geom_vline(aes(xintercept=mean(age)), color = "blue", linetype = "dashed") +
labs(title = "Age Density", x = "Age", y = "Density")
```
```{r, results='markup'}
ggplot(cleanData, aes(x = age, fill = gender)) +
geom_density(alpha = 0.4) +
geom_vline(aes(xintercept=mean(age)), color = "blue", linetype = "dashed") +
labs(title = "Age Density", x = "Age", y = "Density")
```



```{r results='markup'}

#correlation

corr_data <- select_if(cleanData, is.numeric)
cor_mat <- cor(corr_data)
corrplot(cor_mat,method="number")

```
As seen from the above plot, average glucose level and age are slightly correlated



3)do plots
4)show missing values for bmi and smoking_status
5)filling NA for bmi
6)removie for smoking_status 
7)remove outliers
8)smote
9)plot them again : qqplot => normality  
10) Comparison of age,bmi, avg_glucose_level to stroke
11) correlation plot for numeric variables

12) Plot correlation matrix for categorical variables 
13) analysis of residence_type and drop it 
14)Heart Disease: variable + age 

**Data Analysis for Heart Disease**

```{r results='markup'}
select_heart_disease <- select(cleanData, c('heart_disease','stroke'))
heart_effect <- select_heart_disease %>% group_by(heart_disease, stroke) %>% count(stroke)
ggplot(heart_effect, aes(heart_disease, n, fill = stroke)) + 
  geom_bar(stat = 'identity', position='fill') + 
  ggtitle("Distribution for heart disease on stroke")
ggplot(brainData, aes(heart_disease, age, color = stroke)) + 
  geom_boxplot() + 
  ggtitle("Distribution for age vs heart_disease on stroke")
```
 
* After cleaning the data, the plots above predicts that heart disease might actually have an impact on stroke but age has a bigger factor on stroke. We see that an increase in age comes with an increase in heart disease. This means that people in the higher age bracket are prone to heart diseases than people in the lower age bracket, this is the relation between heart disease and age.


```{r, results='markup'}

df_hypertension_stroke <- cleanData %>%
  group_by(hypertension, stroke) %>%
  count(stroke)

df_hypertension_stroke %>%
ggplot(mapping = aes(x = hypertension, y = n, fill = factor(stroke))) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Percentage of subjects with Hypertension vs. without Hypertension", 
       x = "Hypertension", 
       y = "Percentage") +
  scale_fill_brewer(palette = "Paired")

ggplot(cleanData, aes(hypertension, age, color = stroke)) + 
  geom_boxplot() + 
  ggtitle("Distribution for age vs hypertension on stroke")

```


As we can see from the graph that the number of hypertension cases increases with the age due to multiple biological factors.
From the above charts, we see that the number of strokes is correlated to the hypertension status of the subject. But hypertension is in-turn correlated to age.


**Data Analysis for Ever Married**

```{r results='markup'}

ggplot(data = cleanData, mapping = aes(x = ever_married, y = age)) +
  geom_boxplot()

select_married <- select(cleanData, c('ever_married','stroke'))

married_effect <- 
  select_married %>% 
  group_by(ever_married, stroke) %>% 
  count(stroke)

ggplot(married_effect, aes(ever_married, n, fill = stroke)) + 
  geom_bar(stat = 'identity', position='fill') + 
  ggtitle("Distribution for Marriage Status on stroke")

ggplot(cleanData, aes(ever_married, age, color = stroke)) + 
  geom_boxplot() + 
  ggtitle("Distribution for age vs ever_married on stroke")
```

* From the plot above, we see that people who are married are more likely to get stroke but we then notice that age is a contributing factor to this hypothesis. The married people that get stroke are noticed in the older age bracket, which is why we say age is a major contributing factor to stroke.


**Data Analysis for Smoking Status**

```{r results='markup'}
no_na_for_smoking_status <- subset(cleanData, !is.na(smoking_status))

ggplot(no_na_for_smoking_status, aes(smoking_status, age, color = stroke)) + 
  geom_boxplot() + 
  ggtitle("Distribution for age vs smoking_status on stroke")

select_smoke <- select(no_na_for_smoking_status, c('smoking_status','stroke'))

smoke_effect <- select_smoke %>% 
  group_by(smoking_status, stroke) %>% 
  count(stroke)

ggplot(smoke_effect, aes(smoking_status, n, fill = stroke)) + 
  geom_bar(stat = 'identity', position='fill') + 
  ggtitle("Distribution for smoking_status on stroke")
```

After the analysis of smoking status against stroke where `0` is `No` and `1` is `Yes`, we notice that smoking status does not really have an effect on stroke. According to the graph, we see that people who formerly smoked have more tendency to get strokes than people who never smoked and are still smoking. The boxplot distribution then shows that age is indeed has a great effect on stroke, we see that people approximately above 60 and formerly smoked have strokes under a normal distribution and younger people across all distribution do not have strokes.


18)Gender

**Data Analysis for Work Type**

```{r results='markup'}

ggplot(data = cleanData, mapping = aes(x = work_type, y = age)) +
  geom_boxplot()


select_work <- select(cleanData, c('work_type','stroke'))
workType_effect <- select_work %>% 
  group_by(work_type, stroke) %>% 
  count(stroke)

ggplot(workType_effect, aes(work_type, n, fill = stroke)) + 
  geom_bar(stat = 'identity', position='fill') + 
  ggtitle("Distribution for Work Type on stroke")

ggplot(cleanData, aes(work_type, age, color = stroke)) + 
  geom_boxplot() + 
  ggtitle("Distribution for age vs work_type on stroke")

```

* From the box plot people with govt_job, private and self-employed are more likely to get heart stroke. 
But when comparing with age, this might be because people who have stroke in these 3 categories are older. 
So age might be contributing to this dependence. 

20)All the testing anova, chi-square
21)Conclusion : major factor, what all other factors it depends on, (logistic regression test)


**Chi square Testing to check independence of variable**

```{r, results='markup'}
chisquare_for_dataset <- function(df) {     # defined a function to call chisquare test on different datasets. Created this function as it is getting called twice
contable_gender = table(df$gender, df$stroke)
contable_age = table(df$age, df$stroke)
contable_hypertension = table(df$hypertension, df$stroke)
contable_heart_disease = table(df$heart_disease, df$stroke)
contable_ever_married = table(df$ever_married, df$stroke)
contable_work_type = table(df$work_type, df$stroke)
contable_Residence_type = table(df$Residence_type, df$stroke)
contable_avg_glucose_level = table(df$avg_glucose_level, df$stroke)
contable_bmi = table(df$bmi, df$stroke)
contable_smoking_status = table(df$smoking_status, df$stroke)
contable_glucose_group = table(df$glucoseGroup)

chitest_gender = chisq.test(contable_gender)
chitest_age = chisq.test(contable_age)
chitest_hypertension = chisq.test(contable_hypertension)
chitest_heart_disease = chisq.test(contable_heart_disease)
chitest_ever_married = chisq.test(contable_ever_married)
chitest_work_type = chisq.test(contable_work_type)
chitest_Residence_type = chisq.test(contable_Residence_type)
chitest_avg_glucose_level = chisq.test(contable_avg_glucose_level)
chitest_bmi = chisq.test(contable_bmi)
chitest_smoking_status = chisq.test(contable_smoking_status)
chitest_glucose_group = chisq.test(contable_glucose_group)


print(chitest_gender)
print(chitest_age)
print(chitest_hypertension)
print(chitest_heart_disease)
print(chitest_ever_married)
print(chitest_work_type)
print(chitest_Residence_type)
print(chitest_avg_glucose_level)
print(chitest_bmi)
print(chitest_smoking_status)
print(chitest_glucose_group)

}
```

```{r, results='markup'}
print("For up sampled dataset")
chisquare_for_dataset(cleanData)
```


